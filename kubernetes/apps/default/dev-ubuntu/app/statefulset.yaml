---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: dev-ubuntu
  namespace: default
  labels:
    app.kubernetes.io/name: dev-ubuntu
    app.kubernetes.io/instance: dev-ubuntu
spec:
  serviceName: dev-ubuntu
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: dev-ubuntu
      app.kubernetes.io/instance: dev-ubuntu
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dev-ubuntu
        app.kubernetes.io/instance: dev-ubuntu
      annotations:
        tailscale.com/expose: "true"
        tailscale.com/hostname: "dev-ubuntu"
        tailscale.com/tags: "tag:k8s"
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: ubuntu-dev
          image: lscr.io/linuxserver/openssh-server:latest
          securityContext:
            privileged: true
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Starting Ubuntu development environment setup..."

              # Install additional packages
              apt-get update && apt-get install -y \
                zsh \
                curl \
                wget \
                git \
                vim \
                nano \
                htop \
                tree \
                unzip \
                build-essential \
                locales \
                sudo \
                && rm -rf /var/lib/apt/lists/*

              # Configure locale
              locale-gen en_US.UTF-8

              # Create dev user with sudo privileges if not exists
              if ! id "abc" &>/dev/null; then
                usermod -l dev abc || useradd -m -s /bin/zsh -G sudo dev
                echo "dev:dev" | chpasswd
                echo "dev ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
                echo "Created dev user"
              fi

              # Ensure proper ownership of home directory
              mkdir -p /home/dev
              chown -R dev:dev /home/dev

              # Copy setup scripts to dev home
              cat > /home/dev/setup-dev-tools.sh << 'EOF'
              #!/bin/bash
              set -e
              echo "Setting up additional development tools..."

              # Install Homebrew if not present
              if [ ! -d "/home/linuxbrew/.linuxbrew" ]; then
                export NONINTERACTIVE=1
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc
                echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
              fi

              # Source Homebrew environment
              eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

              # Install Oh My Zsh if not present
              if [ ! -d "~/.oh-my-zsh" ]; then
                sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
                sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="agnoster"/' ~/.zshrc
              fi

              # Install common development tools via Homebrew
              brew install \
                gh \
                kubectl \
                helm \
                node \
                python \
                jq \
                yq \
                fzf \
                ripgrep \
                bat \
                exa \
                fd \
                delta \
                lazygit \
                neovim

              echo "Development tools installation complete!"
              echo "Restart your shell or run 'source ~/.zshrc' to apply changes"
              EOF

              chmod +x /home/dev/setup-dev-tools.sh
              chown dev:dev /home/dev/setup-dev-tools.sh

              echo "Setup complete. Starting services..."
              # Let the base image handle SSH startup
              exec /init
          ports:
            - containerPort: 22
              name: ssh
          readinessProbe:
            tcpSocket:
              port: 22
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            tcpSocket:
              port: 22
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          volumeMounts:
            - name: dev-storage
              mountPath: /home/dev
              subPath: home
            - name: dev-storage
              mountPath: /home/linuxbrew
              subPath: homebrew
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "America/Chicago"
            - name: PASSWORD_ACCESS
              value: "true"
            - name: USER_PASSWORD
              value: "dev"
            - name: USER_NAME
              value: "dev"
            - name: SUDO_ACCESS
              value: "true"
            - name: DEBIAN_FRONTEND
              value: noninteractive
            - name: LANG
              value: en_US.UTF-8
            - name: LC_ALL
              value: en_US.UTF-8
      restartPolicy: Always
  volumeClaimTemplates:
    - metadata:
        name: dev-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: openebs-hostpath
        resources:
          requests:
            storage: 50Gi
