---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app gateway-api-crds
  namespace: flux-system
spec:
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  interval: 1h
  path: ./config/crd/standard
  prune: true
  retryInterval: 2m
  sourceRef:
    kind: GitRepository
    name: gateway-api
    namespace: flux-system
  timeout: 5m
  wait: true
  patches:
    # Add v1alpha3 as deprecated version to all policy CRDs
    # This allows proper migration from v1alpha3 to v1
    # TODO: Remove this patch once all v1alpha3 data has been migrated
    - patch: |-
        - op: add
          path: /spec/versions/0
          value:
            name: v1alpha3
            served: false
            storage: false
            deprecated: true
            deprecationWarning: "v1alpha3 is deprecated, use v1 instead"
            schema:
              openAPIV3Schema:
                type: object
      target:
        group: apiextensions.k8s.io
        kind: CustomResourceDefinition
        labelSelector: gateway.networking.k8s.io/policy=true

