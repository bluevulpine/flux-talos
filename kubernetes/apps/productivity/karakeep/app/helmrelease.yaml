---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app karakeep
spec:
  chartRef:
    kind: OCIRepository
    name: karakeep
  interval: 1h
  values:
    controllers:
      karakeep:
        type: deployment
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/home-operations/postgres-init
              tag: rolling
            envFrom: &envFrom
              - secretRef:
                  name: karakeep-secret
          # Fix /run permissions for s6-overlay which expects it to be owned by the app user
          init-run-perms:
            image:
              repository: busybox
              tag: latest
            command: ["sh", "-c", "chown 568:568 /run && chmod 755 /run"]
            securityContext:
              runAsUser: 0
              runAsGroup: 0
              runAsNonRoot: false
        containers:
          app:
            image:
              repository: ghcr.io/karakeep-app/karakeep
              # renovate: datasource=docker depName=ghcr.io/karakeep-app/karakeep
              tag: 0.30.0
            env:
              TZ: "${TIMEZONE}"
              # Server configuration
              NEXTAUTH_URL: https://karakeep.${SECRET_DOMAIN}
              NEXTAUTH_URL_INTERNAL: http://localhost:3000
              # Meilisearch configuration
              MEILI_ADDR: http://localhost:7700
              # Browser configuration for screenshots
              BROWSER_WEB_URL: http://localhost:9222
              CRAWLER_VIDEO_DOWNLOAD: "true"
              CRAWLER_VIDEO_DOWNLOAD_MAX_SIZE: 20000
              CRAWLER_VIDEO_DOWNLOAD_TIMEOUT_SEC: 7200
              CRAWLER_YTDLP_ARGS: --user-agent "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)"
              # Data directory
              DATA_DIR: /data
              DB_WAL_MODE: "false"
              # Disable signups after initial setup (can be changed later)
              DISABLE_SIGNUPS: "true"
              # Disable password auth if using OAuth exclusively
              DISABLE_PASSWORD_AUTH: "false"
              # OAuth configuration for Authentik
              OAUTH_WELLKNOWN_URL: https://sso.${SECRET_DOMAIN}/application/o/karakeep/.well-known/openid-configuration
              OAUTH_PROVIDER_NAME: Authentik
              OAUTH_SCOPE: openid email profile
              OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: "true"
              # Azure OpenAI model configuration
              INFERENCE_TEXT_MODEL: gpt-4o-mini
              INFERENCE_IMAGE_MODEL: gpt-4o-mini
              INFERENCE_ENABLE_AUTO_SUMMARIZATION: "true"
            envFrom: *envFrom
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/health
                    port: &port 3000
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 30
                  failureThreshold: 5
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 1Gi
          # Meilisearch sidecar for full-text search
          meilisearch:
            image:
              repository: docker.io/getmeili/meilisearch
              # renovate: datasource=docker depName=docker.io/getmeili/meilisearch
              tag: v1.35.0
            command:
              - /bin/meilisearch
            args:
              - --experimental-dumpless-upgrade
            env:
              MEILI_ENV: production
              MEILI_NO_ANALYTICS: "true"
              MEILI_DB_PATH: /meili_data
            envFrom: *envFrom
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 1Gi
          # Headless Chrome for web page screenshots
          chrome:
            image:
              repository: gcr.io/zenika-hub/alpine-chrome
              # renovate: datasource=docker depName=gcr.io/zenika-hub/alpine-chrome
              tag: "124"
            command:
              - chromium-browser
            args:
              - --headless
              - --no-sandbox
              - --disable-gpu
              - --disable-dev-shm-usage
              - --remote-debugging-address=0.0.0.0
              - --remote-debugging-port=9222
              - --hide-scrollbars
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 1Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        controller: karakeep
        ports:
          http:
            port: *port
    route:
      app:
        annotations:
          gatus.home-operations.com/endpoint: |
            group: productivity
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: "Karakeep"
          gethomepage.dev/group: "Productivity"
          gethomepage.dev/icon: "karakeep.png"
          gethomepage.dev/description: "Bookmark Manager"
        parentRefs:
          - name: internal
            namespace: network
            sectionName: https
          - name: external
            namespace: network
            sectionName: https
        hostnames:
          - karakeep.${SECRET_DOMAIN}
    persistence:
      data:
        existingClaim: *app
        globalMounts:
          - path: /data
      meili-data:
        existingClaim: karakeep-meili
        advancedMounts:
          karakeep:
            meilisearch:
              - path: /meili_data
      tmp:
        type: emptyDir
      run:
        type: emptyDir
        advancedMounts:
          karakeep:
            init-run-perms:
              - path: /run
            app:
              - path: /run

