---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/tuppr.home-operations.com/kubernetesupgrade_v1alpha1.json
apiVersion: tuppr.home-operations.com/v1alpha1
kind: KubernetesUpgrade
metadata:
  name: kubernetes
spec:
  kubernetes:
    # renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
    version: v1.35.0
  healthChecks:
    # Wait for VolSync backups to complete before upgrading
    - apiVersion: volsync.backube/v1alpha1
      kind: ReplicationSource
      expr: |-
        status.conditions.filter(c, c.type == "Synchronizing").all(c, c.status == "False")
    # Wait for Longhorn volumes to be healthy
    - apiVersion: longhorn.io/v1beta2
      kind: Volume
      expr: |-
        status.state == "attached" && status.robustness == "healthy"
    # Wait for democratic-csi volumes to be properly attached (not pending)
    - apiVersion: storage.k8s.io/v1
      kind: VolumeAttachment
      description: "Ensure democratic-csi volumes are attached"
      expr: |-
        spec.attacher != "org.democratic-csi.truenas" || status.attached == true

