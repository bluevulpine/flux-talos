---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/volsync.backube/kopiamaintenance_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: KopiaMaintenance
metadata:
  name: kopia-maintenance-local
spec:
  # Repository configuration - references the secret with connection details
  repository:
    repository: kopia-maintenance-local-secret
    repositoryType: s3

  # Run maintenance daily at 2:00 AM
  # Stagger with R2 maintenance (which runs at 3:00 AM) to avoid resource contention
  trigger:
    schedule: "0 2 * * *"

  # Keep history of maintenance jobs for debugging
  successfulJobsHistoryLimit: 3

  # Resource limits for maintenance pod
  # Full maintenance can be memory-intensive for large repositories
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 1Gi

  # Security context matching VolSync defaults
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568

  # Maintenance job timeout (3 hours default)
  activeDeadlineSeconds: 10800

