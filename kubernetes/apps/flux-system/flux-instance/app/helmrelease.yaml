---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-instance
spec:
  chartRef:
    kind: OCIRepository
    name: flux-instance
  interval: 1h
  values:
    instance:
      distribution:
        artifact: oci://ghcr.io/controlplaneio-fluxcd/flux-operator-manifests:v0.32.0
        version: 2.x
      cluster:
        networkPolicy: false
      components:
        - source-controller
        - kustomize-controller
        - helm-controller
        - notification-controller
      sync:
        kind: GitRepository
        name: home-kubernetes
        url: https://github.com/bluevulpine/flux-talos
        ref: refs/heads/main
        path: kubernetes/apps
        interval: 1h
      kustomize:
        postBuild:
          substituteFrom:
            - kind: ConfigMap
              name: cluster-settings
            - kind: Secret
              name: cluster-secrets
            - kind: ConfigMap
              name: cluster-settings-user
              optional: true
            - kind: Secret
              name: cluster-secrets-user
        optional: true
        patches:
          - patch: |- # Add SOPS decryption and variable substitution to all Kustomizations
              apiVersion: kustomize.toolkit.fluxcd.io/v1
              kind: Kustomization
              metadata:
                name: not-used
              spec:
                decryption:
                  provider: sops
                  secretRef:
                    name: sops-age
                postBuild:
                  substituteFrom:
                    - kind: ConfigMap
                      name: cluster-settings
                    - kind: Secret
                      name: cluster-secrets
                    - kind: ConfigMap
                      name: cluster-settings-user
                      optional: true
                    - kind: Secret
                      name: cluster-secrets-user
                      optional: true
            target:
              group: kustomize.toolkit.fluxcd.io
              kind: Kustomization
              labelSelector: substitution.flux.home.arpa/disabled notin (true)
          - # Add HelmRelease defaults to all Kustomizations
            patch: |-
              apiVersion: kustomize.toolkit.fluxcd.io/v1
              kind: Kustomization
              metadata:
                name: not-used
              spec:
                patches:
                  - patch: |-
                      apiVersion: helm.toolkit.fluxcd.io/v2
                      kind: HelmRelease
                      metadata:
                        name: not-used
                      spec:
                        install:
                          crds: CreateReplace
                        upgrade:
                          crds: CreateReplace
                    target:
                      group: helm.toolkit.fluxcd.io
                      kind: HelmRelease
            target:
              group: kustomize.toolkit.fluxcd.io
              kind: Kustomization
          - # Remove NetworkPolicies (legacy from k3s template, not needed for Talos + Cilium but kept for safety)
            patch: |-
              $patch: delete
              apiVersion: networking.k8s.io/v1
              kind: NetworkPolicy
              metadata:
                name: not-used
            target:
              group: networking.k8s.io
              kind: NetworkPolicy
          - # Increase the number of reconciliations that can be performed in parallel
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=8
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --kube-api-qps=500
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --kube-api-burst=1000
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --requeue-dependency=5s
            target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
          - # Increase the memory limits
            patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: not-used
              spec:
                template:
                  spec:
                    containers:
                      - name: manager
                        resources:
                          limits:
                            cpu: 2000m
                            memory: 2Gi
            target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
          - # Enable Helm near OOM detection
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=OOMWatch=true
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-memory-threshold=95
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-interval=500ms
            target:
              kind: Deployment
              name: helm-controller

