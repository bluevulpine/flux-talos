---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mosquitto
spec:
  chartRef:
    kind: OCIRepository
    name: mosquitto
  interval: 1h
  values:
    controllers:
      mosquitto:
        type: statefulset
        initContainers:
          init-passwd:
            image:
              repository: public.ecr.aws/docker/library/eclipse-mosquitto
              # renovate: datasource=docker depName=public.ecr.aws/docker/library/eclipse-mosquitto
              tag: 2.0.22
            command:
              - sh
              - -c
              - |
                cp /mosquitto/config-src/passwd.conf /tmp/passwd.conf
                chmod 600 /tmp/passwd.conf
                mosquitto_passwd -U /tmp/passwd.conf
                cp /tmp/passwd.conf /mosquitto/config/passwd.conf
                cp /mosquitto/config-src/mosquitto.conf /mosquitto/config/mosquitto.conf
                chmod 600 /mosquitto/config/passwd.conf
        containers:
          app:
            image:
              repository: public.ecr.aws/docker/library/eclipse-mosquitto
              # renovate: datasource=docker depName=public.ecr.aws/docker/library/eclipse-mosquitto
              tag: 2.0.22
            env:
              TZ: "${TIMEZONE}"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 100Mi
          hasher:
            image:
              repository: public.ecr.aws/docker/library/eclipse-mosquitto
              # renovate: datasource=docker depName=public.ecr.aws/docker/library/eclipse-mosquitto
              tag: 2.0.22
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            command:
              - sh
              - -c
              - |
                set -eu
                echo "[hasher] started at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                ensure_initial() {
                  if [ -f /mosquitto/config-src/passwd.conf ]; then
                    echo "[hasher] initial: hashing passwd.conf"
                    cp /mosquitto/config-src/passwd.conf /tmp/passwd.conf
                    chmod 600 /tmp/passwd.conf
                    mosquitto_passwd -U /tmp/passwd.conf || true
                    cp /tmp/passwd.conf /mosquitto/config/passwd.conf
                    chmod 600 /mosquitto/config/passwd.conf
                    echo "[hasher] initial: copied hashed passwd.conf to /mosquitto/config/passwd.conf"
                    cp /mosquitto/config-src/mosquitto.conf /mosquitto/config/mosquitto.conf || true
                    echo "[hasher] initial: copied mosquitto.conf"
                    if [ -f /mosquitto/config-src/acl.conf ]; then
                      cp /mosquitto/config-src/acl.conf /mosquitto/config/acl.conf
                      chmod 700 /mosquitto/config/acl.conf
                      echo "[hasher] initial: copied acl.conf"
                    fi
                  else
                    echo "[hasher] initial: no passwd.conf found in secret"
                  fi
                  cp /mosquitto/config-src/passwd.conf /tmp/prev-passwd.conf 2>/dev/null || true
                  cp /mosquitto/config-src/mosquitto.conf /tmp/prev-mosquitto.conf 2>/dev/null || true
                  cp /mosquitto/config-src/acl.conf /tmp/prev-acl.conf 2>/dev/null || true
                  echo "[hasher] initial: baseline snapshots captured"
                }
                sighup() {
                  for p in /proc/[0-9]*; do
                    name=$(cat "$p/comm" 2>/dev/null || true)
                    if [ "$name" = "mosquitto" ]; then
                      echo "[hasher] sending SIGHUP to mosquitto pid $(basename "$p")"
                      kill -HUP "$(basename "$p")" || true
                    fi
                  done
                }
                ensure_initial
                # Baseline TLS snapshots
                cp /mosquitto/tls/tls.crt /tmp/prev-tls.crt 2>/dev/null || true
                cp /mosquitto/tls/tls.key /tmp/prev-tls.key 2>/dev/null || true
                while true; do
                  changed=0
                  if [ -f /mosquitto/config-src/passwd.conf ]; then
                    if ! cmp -s /mosquitto/config-src/passwd.conf /tmp/prev-passwd.conf; then
                      echo "[hasher] change detected: passwd.conf; rehashing"
                      cp /mosquitto/config-src/passwd.conf /tmp/prev-passwd.conf
                      cp /mosquitto/config-src/passwd.conf /tmp/passwd.conf
                      chmod 600 /tmp/passwd.conf
                      mosquitto_passwd -U /tmp/passwd.conf || true
                      cp /tmp/passwd.conf /mosquitto/config/passwd.conf
                      chmod 600 /mosquitto/config/passwd.conf
                      echo "[hasher] updated /mosquitto/config/passwd.conf"
                      changed=1
                    fi
                  fi
                  if [ -f /mosquitto/config-src/mosquitto.conf ]; then
                    if ! cmp -s /mosquitto/config-src/mosquitto.conf /tmp/prev-mosquitto.conf; then
                      echo "[hasher] change detected: mosquitto.conf; copying"
                      cp /mosquitto/config-src/mosquitto.conf /tmp/prev-mosquitto.conf
                      cp /mosquitto/config-src/mosquitto.conf /mosquitto/config/mosquitto.conf
                      changed=1
                    fi
                  fi
                  if [ -f /mosquitto/config-src/acl.conf ]; then
                    if ! cmp -s /mosquitto/config-src/acl.conf /tmp/prev-acl.conf; then
                      echo "[hasher] change detected: acl.conf; copying"
                      cp /mosquitto/config-src/acl.conf /tmp/prev-acl.conf
                      cp /mosquitto/config-src/acl.conf /mosquitto/config/acl.conf
                      chmod 700 /mosquitto/config/acl.conf
                      changed=1
                    fi
                  fi
                  # TLS cert/key change detection
                  if [ -f /mosquitto/tls/tls.crt ]; then
                    if ! cmp -s /mosquitto/tls/tls.crt /tmp/prev-tls.crt; then
                      echo "[hasher] change detected: tls.crt; will reload"
                      cp /mosquitto/tls/tls.crt /tmp/prev-tls.crt
                      changed=1
                    fi
                  fi
                  if [ -f /mosquitto/tls/tls.key ]; then
                    if ! cmp -s /mosquitto/tls/tls.key /tmp/prev-tls.key; then
                      echo "[hasher] change detected: tls.key; will reload"
                      cp /mosquitto/tls/tls.key /tmp/prev-tls.key
                      changed=1
                    fi
                  fi
                  if [ "$changed" = "1" ]; then
                    echo "[hasher] changes applied; signaling mosquitto"
                    sighup
                  fi
                  sleep 5
                done
            resources:
              requests:
                cpu: 5m
              limits:
                memory: 64Mi

    defaultPodOptions:
      shareProcessNamespace: true
      tolerations:
        - key: "node.kubernetes.io/low-power"
          operator: "Equal"
          value: "raspberry-pi"
          effect: "NoSchedule"
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: "kubernetes.io/hostname"
                    operator: "In"
                    values:
                      - "jormungandr4"
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        type: LoadBalancer
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "mqtt.${SECRET_DOMAIN_MEDIA},mqtt.${SECRET_DOMAIN}"
          lbipam.cilium.io/ips: "${SVC_MOSQUITTO_ADDR}"
        ports:
          mqtt:
            port: 1883
          mqtts:
            port: 8883
    persistence:
      data:
        existingClaim: ${APP}

        globalMounts:
          - path: /mosquitto/data
            subPath: data
      log:
        type: emptyDir
        globalMounts:
          - path: /mosquitto/log
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
      config-src:
        type: secret
        name: mosquitto-secret
        globalMounts:
          - path: /mosquitto/config-src
            readOnly: true
      config:
        type: emptyDir
        globalMounts:
          - path: /mosquitto/config
      tls:
        type: secret
        name: mosquitto-tls
        globalMounts:
          - path: /mosquitto/tls
            readOnly: true

