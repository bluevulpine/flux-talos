---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app gitea
spec:
  interval: 30m
  chart:
    spec:
      chart: gitea
      version: 12.4.0
      sourceRef:
        kind: HelmRepository
        name: gitea
      interval: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    ## Image configuration
    image:
      registry: "docker.io"
      repository: gitea/gitea
      # renovate: datasource=docker depName=gitea/gitea
      tag: 1.25.3
      rootless: true

    ## Deployment configuration
    replicaCount: 1

    ## Service configuration
    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: LoadBalancer
        port: 22
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "git.${SECRET_DOMAIN}"
          lbipam.cilium.io/ips: "${SVC_GITEA_SSH_ADDR}"

    ## Ingress - disabled, using HTTPRoute instead
    ingress:
      enabled: false

    ## Resources
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi

    ## Persistence - use existing PVC from VolSync
    persistence:
      enabled: true
      create: false
      mount: true
      claimName: gitea

    ## Database init container
    preExtraInitContainers:
      - name: init-db
        image: ghcr.io/home-operations/postgres-init:rolling
        envFrom:
          - secretRef:
              name: gitea-secret

    ## Gitea configuration
    gitea:
      ## Admin user - skip creation since admin already exists
      admin:
        existingSecret: gitea-secret
        email: "admin@gitea.local"
        passwordMode: initialOnlyNoReset

      ## Metrics
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

      ## OAuth2 configuration for Authentik SSO
      oauth:
        - name: "Authentik"
          provider: "openidConnect"
          existingSecret: gitea-oauth-secret
          autoDiscoverUrl: "https://sso.${SECRET_DOMAIN}/application/o/gitea/.well-known/openid-configuration"
          iconUrl: "https://sso.${SECRET_DOMAIN}/static/dist/assets/icons/icon.png"
          scopes: "openid email profile"

      ## Gitea app.ini configuration
      config:
        APP_NAME: "Gitea"

        server:
          DOMAIN: "gitea.${SECRET_DOMAIN}"
          ROOT_URL: "https://gitea.${SECRET_DOMAIN}"
          SSH_PORT: 22
          SSH_LISTEN_PORT: 2222
          LFS_START_SERVER: true

        database:
          DB_TYPE: postgres
          HOST: postgres16-rw.database.svc.cluster.local:5432
          NAME: gitea

        security:
          INSTALL_LOCK: true

        service:
          DISABLE_REGISTRATION: true
          REQUIRE_SIGNIN_VIEW: false
          ALLOW_ONLY_EXTERNAL_REGISTRATION: true
          SHOW_REGISTRATION_BUTTON: false

        openid:
          ENABLE_OPENID_SIGNIN: false
          ENABLE_OPENID_SIGNUP: false

        oauth2_client:
          ENABLE_AUTO_REGISTRATION: true
          USERNAME: email
          ACCOUNT_LINKING: auto
          UPDATE_AVATAR: true

        mailer:
          ENABLED: true
          PROTOCOL: smtp
          SMTP_ADDR: smtp-relay.infrastructure.svc.cluster.local
          SMTP_PORT: 25
          FROM: "gitea@${SECRET_DOMAIN}"

        actions:
          ENABLED: true

        cache:
          ADAPTER: memory

        session:
          PROVIDER: memory

      ## Additional config from secret (for sensitive values)
      additionalConfigFromEnvs:
        - name: GITEA__DATABASE__USER
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__database__USER
        - name: GITEA__DATABASE__PASSWD
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__database__PASSWD
        - name: GITEA__SECURITY__SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__security__SECRET_KEY
        - name: GITEA__SECURITY__INTERNAL_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__security__INTERNAL_TOKEN
        - name: GITEA__SERVER__LFS_JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__server__LFS_JWT_SECRET
        - name: GITEA__OAUTH2__JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gitea-secret
              key: GITEA__oauth2__JWT_SECRET

    ## Disable built-in PostgreSQL (using external CNPG)
    postgresql:
      enabled: false

    postgresql-ha:
      enabled: false

    ## Disable built-in Redis/Valkey (using memory for now)
    valkey-cluster:
      enabled: false

    valkey:
      enabled: false

    ## Test pod
    test:
      enabled: false

