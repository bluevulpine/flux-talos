---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name nexus-secret
spec:
  secretStoreRef:
    name: bitwarden-secrets-manager
    kind: ClusterSecretStore

  target:
    name: *name
    template:
      engineVersion: v2
      data:
        # Database connection for postgres-init
        INIT_POSTGRES_HOST: postgres16-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: nexus
        INIT_POSTGRES_PASS: "{{ .Nexus__DatabasePassword }}"
        INIT_POSTGRES_DBNAME: nexus
        INIT_POSTGRES_SUPER_PASS: "{{ .Postgres__SuperPassword }}"

        # Nexus application configuration
        NEXUS_SECURITY_RANDOMPASSWORD: "false"
        NEXUS_SECURITY_INITIAL_PASSWORD: "{{ .Nexus__AdminPassword }}"

        # Database configuration for Nexus
        NEXUS_DATASTORE_NEXUS_JDBCURL: "jdbc:postgresql://postgres16-rw.database.svc.cluster.local:5432/nexus"
        NEXUS_DATASTORE_NEXUS_USERNAME: nexus
        NEXUS_DATASTORE_NEXUS_PASSWORD: "{{ .Nexus__DatabasePassword }}"

  dataFrom:
    - extract:
        key: nexus
    - extract:
        key: cloudnative-pg
