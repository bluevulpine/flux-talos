---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app nexus
spec:
  interval: 30m
  chart:
    spec:
      # renovate: registryUrl=https://stevehipwell.github.io/helm-charts/
      chart: nexus3
      version: 5.17.1
      sourceRef:
        kind: HelmRepository
        name: stevehipwell
        namespace: flux-system
      interval: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # Image configuration
    # renovate: datasource=docker depName=sonatype/nexus3
    image:
      repository: docker.io/sonatype/nexus3
      tag: 3.88.0

    # JVM memory settings - 2GB heap with 4GB direct memory for blob operations
    install4jAddVmParams: "-Xms2048m -Xmx2048m -XX:MaxDirectMemorySize=4096m"

    # Nexus properties - enable external PostgreSQL datastore
    # The actual connection details are passed via environment variables
    properties:
      - nexus.datastore.enabled=true

    # Environment variables from secret for PostgreSQL connection
    # Nexus reads these at startup for database configuration
    env:
      - name: NEXUS_SECURITY_RANDOMPASSWORD
        valueFrom:
          secretKeyRef:
            name: nexus-secret
            key: NEXUS_SECURITY_RANDOMPASSWORD
      - name: NEXUS_DATASTORE_NEXUS_JDBCURL
        valueFrom:
          secretKeyRef:
            name: nexus-secret
            key: NEXUS_DATASTORE_NEXUS_JDBCURL
      - name: NEXUS_DATASTORE_NEXUS_USERNAME
        valueFrom:
          secretKeyRef:
            name: nexus-secret
            key: NEXUS_DATASTORE_NEXUS_USERNAME
      - name: NEXUS_DATASTORE_NEXUS_PASSWORD
        valueFrom:
          secretKeyRef:
            name: nexus-secret
            key: NEXUS_DATASTORE_NEXUS_PASSWORD

    # Resource configuration
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 6Gi

    # Persistence - StatefulSet volumeClaimTemplate
    # Using longhorn-1-replica since this is cache data (no backup needed)
    persistence:
      enabled: true
      storageClass: longhorn-1-replica
      size: 100Gi
      retainDeleted: false  # Delete PVC when StatefulSet is deleted
      retainScaled: true

    # Enable chown init container to fix PVC ownership
    # Requires 'privileged' PodSecurity on the develop namespace
    chownDataDir: true

    # Init container to create PostgreSQL database and user
    # Uses INIT_POSTGRES_* env vars from nexus-secret
    extraInitContainers:
      - name: init-db
        image: ghcr.io/home-operations/postgres-init:rolling
        envFrom:
          - secretRef:
              name: nexus-secret

    # Metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false  # Using separate ServiceMonitor

    # Service configuration
    service:
      type: ClusterIP
      port: 8081
      # Docker registry ports for each proxy repository
      # Each proxy has its own port for proper per-registry mirroring
      additionalPorts:
        - port: 5000
          name: docker
          containerPort: 5000
        - port: 5001
          name: docker-hub
          containerPort: 5001
        - port: 5002
          name: ghcr
          containerPort: 5002
        - port: 5003
          name: quay
          containerPort: 5003
        - port: 5004
          name: lscr
          containerPort: 5004
        - port: 5005
          name: gcr
          containerPort: 5005
        - port: 5006
          name: ecr
          containerPort: 5006
        - port: 5007
          name: cgr
          containerPort: 5007

    # Ingress disabled (using HTTPRoute instead)
    ingress:
      enabled: false

    # Root password from secret for config job
    rootPassword:
      secret: nexus-secret
      key: NEXUS_SECURITY_INITIAL_PASSWORD

    # ========================================
    # DECLARATIVE CONFIGURATION
    # ========================================
    config:
      enabled: true

      # Enable anonymous access for Docker pulls (containerd needs this)
      anonymous:
        enabled: true
        roles:
          - nx-anonymous
          - nx-metrics

      # Enable required authentication realms
      realms:
        enabled: true
        values:
          - NexusAuthenticatingRealm
          - DockerToken
          - NpmToken

      # Blob stores - separate by artifact type for different retention policies
      blobStores:
        # Docker images - largest, most aggressive cleanup
        - name: docker
          type: file
          path: /nexus-data/blobs/docker
        # APT packages - moderate size, longer retention
        - name: apt
          type: file
          path: /nexus-data/blobs/apt
        # npm/PyPI packages - moderate size
        - name: packages
          type: file
          path: /nexus-data/blobs/packages

      # Cleanup policies to prevent unbounded storage growth
      cleanup:
        # Docker images not downloaded in 30 days
        - name: docker-cleanup
          notes: "Remove Docker layers not downloaded in 30 days"
          format: docker
          mode: delete
          criteria:
            lastDownloaded: "2592000"  # 30 days in seconds
        # APT packages not downloaded in 90 days
        - name: apt-cleanup
          notes: "Remove APT packages not downloaded in 90 days"
          format: apt
          mode: delete
          criteria:
            lastDownloaded: "7776000"  # 90 days in seconds
        # npm/PyPI packages not downloaded in 60 days
        - name: packages-cleanup
          notes: "Remove npm/PyPI packages not downloaded in 60 days"
          format: ALL_FORMATS
          mode: delete
          criteria:
            lastDownloaded: "5184000"  # 60 days in seconds

      # Repository configuration
      repos:
        # ========================================
        # DOCKER REGISTRY PROXIES
        # ========================================
        # Shared defaults for Docker proxy repositories (REGISTRY index type)
        - &docker-proxy-defaults
          name: ghcr-proxy
          format: docker
          type: proxy
          online: true
          storage:
            blobStoreName: docker
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://ghcr.io
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5002
          dockerProxy:
            indexType: REGISTRY
            cacheForeignLayers: true
          cleanup:
            policyNames:
              - docker-cleanup

        # Docker Hub (docker.io / registry-1.docker.io) - uses HUB index type
        - <<: *docker-proxy-defaults
          name: docker-hub-proxy
          proxy:
            remoteUrl: https://registry-1.docker.io
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5001
          dockerProxy:
            indexType: HUB
            cacheForeignLayers: true

        # Quay.io
        - <<: *docker-proxy-defaults
          name: quay-proxy
          proxy:
            remoteUrl: https://quay.io
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5003

        # LinuxServer.io Container Registry (lscr.io)
        - <<: *docker-proxy-defaults
          name: lscr-proxy
          proxy:
            remoteUrl: https://lscr.io
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5004

        # Google Container Registry mirror (mirror.gcr.io)
        - <<: *docker-proxy-defaults
          name: gcr-mirror-proxy
          proxy:
            remoteUrl: https://mirror.gcr.io
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5005

        # AWS ECR Public (public.ecr.aws)
        - <<: *docker-proxy-defaults
          name: ecr-public-proxy
          proxy:
            remoteUrl: https://public.ecr.aws
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5006

        # Chainguard Registry (cgr.dev)
        - <<: *docker-proxy-defaults
          name: chainguard-proxy
          proxy:
            remoteUrl: https://cgr.dev
            contentMaxAge: 1440
            metadataMaxAge: 1440
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5007

        # Docker Group - combines all Docker proxies into single endpoint on port 5000
        - name: docker-group
          format: docker
          type: group
          online: true
          storage:
            blobStoreName: docker
            strictContentTypeValidation: true
          group:
            memberNames:
              - docker-hub-proxy
              - ghcr-proxy
              - quay-proxy
              - lscr-proxy
              - gcr-mirror-proxy
              - ecr-public-proxy
              - chainguard-proxy
          docker:
            v1Enabled: false
            forceBasicAuth: false
            httpPort: 5000

        # ========================================
        # PACKAGE MANAGER PROXIES
        # ========================================
        # npm Registry
        - name: npm-proxy
          format: npm
          type: proxy
          online: true
          storage:
            blobStoreName: packages
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://registry.npmjs.org
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          cleanup:
            policyNames:
              - packages-cleanup

        # PyPI Registry
        - name: pypi-proxy
          format: pypi
          type: proxy
          online: true
          storage:
            blobStoreName: packages
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://pypi.org
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          cleanup:
            policyNames:
              - packages-cleanup

        # ========================================
        # APT REPOSITORY PROXIES (for DietPi/Raspberry Pi)
        # ========================================
        # Debian Main Repository
        - name: apt-debian
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: http://deb.debian.org/debian/
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

        # Debian Security Repository
        - name: apt-debian-security
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: http://deb.debian.org/debian-security/
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm-security
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

        # DietPi Repository
        - name: apt-dietpi
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://dietpi.com/apt
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

        # Docker CE Repository
        - name: apt-docker
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://download.docker.com/linux/debian/
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

        # Raspberry Pi Repository
        - name: apt-raspberrypi
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://archive.raspberrypi.com/debian
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

        # Tailscale Repository
        - name: apt-tailscale
          format: apt
          type: proxy
          online: true
          storage:
            blobStoreName: apt
            strictContentTypeValidation: true
          proxy:
            remoteUrl: https://pkgs.tailscale.com/stable/debian
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: bookworm
            flat: false
          cleanup:
            policyNames:
              - apt-cleanup

      # Scheduled tasks for maintenance
      tasks:
        # Run cleanup policies daily at 2 AM
        - name: "Cleanup service"
          typeId: repository.cleanup
          crontab: "0 0 2 * * ?"
          attributes: {}

        # Purge incomplete Docker uploads daily at 3 AM
        - name: "Docker cleanup uploads"
          typeId: repository.docker.upload-purge
          crontab: "0 0 3 * * ?"
          attributes:
            age: "24"

        # Docker garbage collection daily at 4 AM
        - name: "Docker garbage collection"
          typeId: repository.docker.gc
          crontab: "0 0 4 * * ?"
          attributes:
            repositoryName: "*"

        # Compact blob stores weekly on Sunday at 5 AM
        - name: "Compact docker blob store"
          typeId: blobstore.compact
          crontab: "0 0 5 ? * SUN"
          attributes:
            blobStoreName: docker

        - name: "Compact apt blob store"
          typeId: blobstore.compact
          crontab: "0 30 5 ? * SUN"
          attributes:
            blobStoreName: apt

        - name: "Compact packages blob store"
          typeId: blobstore.compact
          crontab: "0 0 6 ? * SUN"
          attributes:
            blobStoreName: packages
